pipeline {
    agent any
    
    environment {
        PROJECT_NAME = 'tri-bulles-dev'
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo '=== [DEV] R√©cup√©ration du code source ==='
                git branch: 'main',
                    url: 'https://github.com/Elyesssss/Jenkins.git'
            }
        }
        
        stage('V√©rification environnement') {
            steps {
                echo '=== [DEV] V√©rification des outils ==='
                sh '''
                    echo "V√©rification de GCC..."
                    gcc --version
                    echo ""
                    echo "V√©rification de Make..."
                    make --version
                '''
            }
        }
        
        stage('Compilation') {
            steps {
                echo '=== [DEV] Compilation du programme ==='
                sh '''
                    echo "Nettoyage..."
                    make clean || true
                    echo ""
                    echo "Compilation des programmes..."
                    make all
                    echo ""
                    echo "V√©rification des binaires..."
                    ls -lh build/
                '''
            }
        }
        
        stage('Tests unitaires') {
            steps {
                echo '=== [DEV] Ex√©cution des tests unitaires ==='
                sh '''
                    echo "Tests tri d'entiers..."
                    make test_bulles
                    echo ""
                    echo "Tests tri de cha√Ænes..."
                    make test_chaines
                    echo ""
                    echo "‚úÖ Tous les tests sont pass√©s !"
                '''
            }
        }
        
        stage('Rapport de tests') {
            steps {
                echo '=== [DEV] G√©n√©ration du rapport ==='
                sh '''
                    echo "=== RAPPORT DE TESTS ===" > rapport_dev.txt
                    echo "Date: $(date)" >> rapport_dev.txt
                    echo "Build: ${BUILD_NUMBER}" >> rapport_dev.txt
                    echo "" >> rapport_dev.txt
                    echo "Programmes compil√©s:" >> rapport_dev.txt
                    ls -lh build/ >> rapport_dev.txt
                    echo "" >> rapport_dev.txt
                    echo "Tests r√©ussis: ‚úÖ" >> rapport_dev.txt
                    cat rapport_dev.txt
                '''
                archiveArtifacts artifacts: 'rapport_dev.txt, build/*',
                                fingerprint: true
            }
        }
    }
    
    post {
        success {
            echo '‚úÖ [DEV] Pipeline ex√©cut√© avec succ√®s !'
            echo 'üì¶ Les artefacts sont disponibles pour le d√©ploiement'
        }
        failure {
            echo '‚ùå [DEV] Le pipeline a √©chou√©.'
            echo 'üîç V√©rifiez les logs pour identifier le probl√®me'
        }
        always {
            echo '=== [DEV] Nettoyage ==='
            sh 'make clean || true'
        }
    }
}
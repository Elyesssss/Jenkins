pipeline {
    agent any
    
    environment {
        PROJECT_NAME = 'tri-bulles-et-chaines-dev'
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo '=== [DEV] Récupération du code source ==='
                git branch: 'main',
                    url: 'https://github.com/Elyesssss/Jenkins.git'
            }
        }
        
        stage('Vérification environnement') {
            steps {
                echo '=== [DEV] Vérification des outils ==='
                sh '''
                    echo "Vérification de GCC..."
                    gcc --version
                    echo ""
                    echo "Vérification de Make..."
                    make --version
                '''
            }
        }
        
        stage('Compilation') {
            steps {
                echo '=== [DEV] Compilation du programme ==='
                sh '''
                    echo "Nettoyage..."
                    make clean || true
                    echo ""
                    echo "Compilation des programmes..."
                    make all
                    echo ""
                    echo "Vérification des binaires..."
                    ls -lh build/
                '''
            }
        }
        
        stage('Tests unitaires') {
            steps {
                echo '=== [DEV] Exécution des tests unitaires ==='
                sh '''
                    echo "Tests tri d'entiers..."
                    make test_bulles
                    echo ""
                    echo "Tests tri de chaînes..."
                    make test_chaines
                    echo ""
                    echo " Tous les tests sont passés !"
                '''
            }
        }
        
        stage('Exécution des programmes') {
            steps {
                echo '=== [DEV] Exécution des programmes ==='
                sh '''
                    echo "Exécution du tri à bulles..."
                    ./build/tri_bulles
                    echo ""
                    echo "Exécution du tri de chaînes..."
                    ./build/tri_chaines
                    echo ""
                    echo "Les deux programmes ont été exécutés avec succès !"
                '''
            }
        }
        
        stage('Rapport de tests') {
            steps {
                echo '=== [DEV] Génération du rapport ==='
                sh '''
                    echo "=== RAPPORT DE TESTS ===" > rapport_dev.txt
                    echo "Date: $(date)" >> rapport_dev.txt
                    echo "Build: ${BUILD_NUMBER}" >> rapport_dev.txt
                    echo "" >> rapport_dev.txt
                    echo "Programmes compilés:" >> rapport_dev.txt
                    ls -lh build/ >> rapport_dev.txt
                    echo "" >> rapport_dev.txt
                    echo "Tests réussis: " >> rapport_dev.txt
                    cat rapport_dev.txt
                '''
                archiveArtifacts artifacts: 'rapport_dev.txt, build/*',
                                fingerprint: true
            }
        }
    }
    
    post {
        success {
            echo ' [DEV] Pipeline exécuté avec succès !'
            echo ' Les artefacts sont disponibles pour le déploiement'
        }
        failure {
            echo ' [DEV] Le pipeline a échoué.'
            echo ' Vérifiez les logs pour identifier le problème'
        }
        always {
            echo '=== [DEV] Nettoyage ==='
            sh 'make clean || true'
        }
    }
}
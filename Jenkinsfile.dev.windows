pipeline {
    agent any
    
    environment {
        PROJECT_NAME = 'tri-bulles-et-chaines-dev'
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo '=== [DEV] Récupération du code source ==='
                git branch: 'main',
                    url: 'https://github.com/Elyesssss/Jenkins.git'
            }
        }
        
        stage('Vérification environnement') {
            steps {
                echo '=== [DEV] Vérification des outils ==='
                bat '''
                    echo Vérification de GCC...
                    gcc --version
                    echo.
                    echo Vérification de Make...
                    make --version
                '''
            }
        }
        
        stage('Compilation') {
            steps {
                echo '=== [DEV] Compilation du programme ==='
                bat '''
                    echo Nettoyage...
                    make clean
                    echo.
                    echo Compilation des programmes...
                    make all
                    echo.
                    echo Vérification des binaires...
                    dir build
                '''
            }
        }
        
        stage('Tests unitaires') {
            steps {
                echo '=== [DEV] Exécution des tests unitaires ==='
                bat '''
                    echo Tests tri d'entiers...
                    make test_bulles
                    echo.
                    echo Tests tri de chaînes...
                    make test_chaines
                    echo.
                    echo Tous les tests sont passés !
                '''
            }
        }
        
        stage('Exécution des programmes') {
            steps {
                echo '=== [DEV] Exécution des programmes ==='
                bat '''
                    echo Exécution du tri à bulles...
                    ./build/tri_bulles.exe
                    echo.
                    echo Exécution du tri de chaînes...
                    ./build/tri_chaines.exe
                    echo.
                    echo Les deux programmes ont été exécutés avec succès !
                '''
            }
        }
        
        stage('Rapport de tests') {
            steps {
                echo '=== [DEV] Génération du rapport ==='
                bat '''
                    echo === RAPPORT DE TESTS === > rapport_dev.txt
                    echo Date: %DATE% %TIME% >> rapport_dev.txt
                    echo Build: %BUILD_NUMBER% >> rapport_dev.txt
                    echo. >> rapport_dev.txt
                    echo Programmes compilés: >> rapport_dev.txt
                    dir build >> rapport_dev.txt
                    echo. >> rapport_dev.txt
                    echo Tests réussis >> rapport_dev.txt
                    type rapport_dev.txt
                '''
                archiveArtifacts artifacts: 'rapport_dev.txt, build/*',
                                fingerprint: true
            }
        }
        
        stage('Trigger OPS Pipeline') {
            steps {
                echo '=== [DEV] Déclenchement du pipeline OPS ==='
                echo 'Lancement de tri-bulles-ops...'
                build job: 'tri-bulles-ops', 
                      wait: false,
                      parameters: [
                          string(name: 'TRIGGERED_BY', value: "DEV-Build-${env.BUILD_NUMBER}")
                      ]
            }
        }
    }
    
    post {
        success {
            echo '[DEV] Pipeline exécuté avec succès !'
            echo 'Les artefacts sont disponibles pour le déploiement'
            echo 'Pipeline OPS (tri-bulles-ops) a été déclenché automatiquement'
        }
        failure {
            echo '[DEV] Le pipeline a échoué.'
            echo 'Vérifiez les logs pour identifier le problème'
            echo 'Pipeline OPS non déclenché'
        }
        always {
            echo '=== [DEV] Nettoyage ==='
            bat 'make clean || exit 0'
        }
    }
}